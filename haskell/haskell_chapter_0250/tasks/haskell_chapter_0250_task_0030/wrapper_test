module Main where
import Test.Hspec
import Test.Hspec.Core.Runner hiding (registerFormatter)
import Test.Hspec.Api.Format.V2
import Test.QuickCheck
import MachineFormatter (formatter)

import UserCode hiding (clamp)

main :: IO ()
main = hspecWith (registerFormatter formatter defaultConfig) spec

clamp :: Int -> Int -> Int -> Int
clamp a val = min (max a val)

data Steam = Steam Int Bool deriving (Show)
data EpicGames = EpicGames Int Bool deriving (Show)

instance Account Steam where
    getPlayedTime (Steam t _) = t

instance Account EpicGames where
    getPlayedTime (EpicGames t _) = t

instance AccountExtended EpicGames where
    isVIP (EpicGames _ v) = v

instance AccountExtended Steam where
    isVIP (Steam _ v) = v

spec :: Spec
spec = do
    describe "calcDiscount" $ do
        it "скидка считается верно" $ property
            (\playTime isBF isVIP' -> let baseMod = clamp 0 playTime 15 
                                          baseDiscount = clamp 0 (if isBF then baseMod + 10 else baseMod) 20
                                          expected = baseDiscount + (if isVIP' then 10 else 0)
                                     in calcDiscount (Steam playTime isVIP') isBF `shouldBe` expected)
        it "работает с любым классом" $ do
            calcDiscount (Steam 0 False) False `shouldBe` 0
            calcDiscount (EpicGames 0 False) False `shouldBe` 0

